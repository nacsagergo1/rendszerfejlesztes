<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <title>Profil</title>
    <link rel="icon" href="/img/icon.png" />
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
    <div id="nav" class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container">
            <a href="/" id="home" class="navbar-brand">A nagyi étterme</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul id="navigation" class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a href="/menu" class="nav-link">Étlap</a>
                    </li>                    <li class="nav-item"><a href="/reserve" class="nav-link">Foglalás</a></li>
                    <li class="nav-item"><a href="/reviews" class="nav-link">Vélemények</a></li>
                    <li class="nav-item"><a href="/contact" class="nav-link">Kapcsolat</a></li>
                    <% if (typeof user === 'undefined') { %>
                        <li class="nav-item">
                            <a href="/login" class="nav-link">Bejelentkezés</a>
                        </li>
                        <% } else if (user.role === 'admin'){ %>
                            <li class="nav-item">
                                <a href="/profile" class="nav-link">Profil</a>
                            </li>
                            <li>
                                <a href="/usersAdmin" class="nav-link">Felhasználók kezelése</a>
                            </li>
                            <li class="nav-item">
                                <a href="/logout" class="nav-link">Kijelentkezés</a>
                            </li>
                        <%} else { %>
                        <li class="nav-item">
                            <a href="/profile" class="nav-link">Profil</a>
                        </li>
                        <li class="nav-item">
                            <a href="/logout" class="nav-link">Kijelentkezés</a>
                        </li>
                        <% } %>
                </ul>
            </div>
        </div>
    </div>
    

<div id="profile-container" class="container mt-5">
    <h1 class="text-center mt-5 pt-5" style="margin-top: 120px !important;">Profil adatai</h1>
    
    <div class="form-group">
        <label for="email">Email:</label>
        <p id="email"><%= user.email %></p>
    </div>

    <!-- Jövőbeli foglalások -->
    <div class="form-group">
        <h2 class="text-center">Jövőbeli foglalások</h2>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Felhasználó ID</th>
                    <th>Foglalás dátuma</th>
                    <th>Várható létszám</th>
                    <th>Üzlet</th>
                    <th>Műveletek</th>
                </tr>
            </thead>
            <tbody id="future-reservations-body">
                <tr>
                    <td colspan="6" class="text-center">Nincsenek jövőbeli foglalások.</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Múltbeli foglalások -->
    <div class="form-group">
        <h2 class="text-center" style="margin-top: 120px !important;">Múltbeli foglalások</h2>
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Felhasználó ID</th>
                    <th>Foglalás dátuma</th>
                    <th>Várható létszám</th>
                    <th>Üzlet</th>
                </tr>
            </thead>
            <tbody id="past-reservations-body">
                <tr>
                    <td colspan="5" class="text-center">Nincsenek múltbeli foglalások.</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    async function fetchReservations() {
        try {
            const response = await fetch('/list-reservations');
            const data = await response.json();

            // Jövőbeli foglalások renderelése
            const futureBody = document.getElementById('future-reservations-body');
            futureBody.innerHTML = '';
            if (data.user.bookings && data.user.bookings.length > 0) {
                data.user.bookings.forEach(booking => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${booking.ID}</td>
                        <td>${booking.User_ID}</td>
                        <td>${new Date(booking.Reservation_Date).toLocaleString()}</td>
                        <td>${booking.Expected_Party_Size}</td>
                        <td>${booking.Business}</td>
                        <td>
                            <button class="btn btn-warning btn-sm modify-btn" data-id="${booking.ID}">Módosítás</button>
                        </td>
                    `;
                    futureBody.appendChild(row);
                });
            } else {
                futureBody.innerHTML = `<tr><td colspan="6" class="text-center">Nincsenek jövőbeli foglalások.</td></tr>`;
            }

            // Múltbeli foglalások renderelése
            const pastBody = document.getElementById('past-reservations-body');
            pastBody.innerHTML = '';
            if (data.user.pastBookings && data.user.pastBookings.length > 0) {
                data.user.pastBookings.forEach(booking => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${booking.ID}</td>
                        <td>${booking.User_ID}</td>
                        <td>${new Date(booking.Reservation_Date).toLocaleString()}</td>
                        <td>${booking.Expected_Party_Size}</td>
                        <td>${booking.Business}</td>
                    `;
                    pastBody.appendChild(row);
                });
            } else {
                pastBody.innerHTML = `<tr><td colspan="5" class="text-center">Nincsenek múltbeli foglalások.</td></tr>`;
            }
        } catch (error) {
            console.error('Error loading reservations:', error);
        }
    }

    // A foglalások betöltése az oldal betöltődésekor
    document.addEventListener('DOMContentLoaded', fetchReservations);
</script>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
<script>
    let reservationsData = {};

    async function fetchReservations() {
        try {
            const response = await fetch('/list-reservations');
            reservationsData = await response.json();

            const futureBody = document.getElementById('future-reservations-body');
            futureBody.innerHTML = '';
            if (reservationsData.user.bookings && reservationsData.user.bookings.length > 0) {
                reservationsData.user.bookings.forEach(booking => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${booking.ID}</td>
                        <td>${booking.User_ID}</td>
                        <td>${new Date(booking.Reservation_Date).toLocaleString()}</td>
                        <td>${booking.Expected_Party_Size}</td>
                        <td>${booking.Business}</td>
                        <td>
                            <button class="btn btn-warning btn-sm modify-btn" data-id="${booking.ID}">Módosítás</button>
                        </td>
                    `;
                    futureBody.appendChild(row);
                });
            } else {
                futureBody.innerHTML = `<tr><td colspan="6" class="text-center">Nincsenek jövőbeli foglalások.</td></tr>`;
            }

            const pastBody = document.getElementById('past-reservations-body');
            pastBody.innerHTML = '';
            if (reservationsData.user.pastBookings && reservationsData.user.pastBookings.length > 0) {
                reservationsData.user.pastBookings.forEach(booking => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${booking.ID}</td>
                        <td>${booking.User_ID}</td>
                        <td>${new Date(booking.Reservation_Date).toLocaleString()}</td>
                        <td>${booking.Expected_Party_Size}</td>
                        <td>${booking.Business}</td>
                    `;
                    pastBody.appendChild(row);
                });
            } else {
                pastBody.innerHTML = `<tr><td colspan="5" class="text-center">Nincsenek múltbeli foglalások.</td></tr>`;
            }
        } catch (error) {
            console.error('Error loading reservations:', error);
        }
    }
    $(document).on('click', '.modify-btn', function() {
        const bookingId = $(this).data('id');
        
        const booking = reservationsData.user.bookings.find(b => b.ID === bookingId);
        
        if (booking) {
            $('#reservationDate').val(new Date(booking.Reservation_Date).toISOString().substring(0, 10));
            $('#expectedPartySize').val(booking.Expected_Party_Size);
            $('#business').val(booking.Business);

            const reservationDate = new Date(booking.Reservation_Date);
            $('#reservationHour').val(reservationDate.getHours());
            $('#reservationMinute').val(reservationDate.getMinutes());
        }

        $('#modifyModal').modal('show');

        window.currentBookingId = bookingId;    
    });

    $(document).on('click', '#deleteReservationBtn', function() {
        const bookingId = window.currentBookingId;
        
        if (bookingId) {
            console.log("Foglalás ID:", bookingId);

            $.ajax({
                url: '/deleteReservation',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ resID: bookingId }),
                success: function(response) {
                    if (response.success) {
                        alert('Foglalás sikeresen törölve.');
                        fetchReservations();
                    } else {
                        alert('Hiba történt a foglalás törlésekor: ' + response.error);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error occurred:', error);
                    alert('Hiba történt a foglalás törlésekor.');
                }
            });
        } else {
            console.log("Nincs foglalás ID.");
        }
    });

    $(document).on('click', '#saveChangesBtn', function() {
        const bookingId = window.currentBookingId;
        const numberOfPerson = $('#expectedPartySize').val();
        const unformedDate = $('#reservationDate').val();
        const hour = $('#reservationHour').val();
        const minute = $('#reservationMinute').val();

        if (bookingId && numberOfPerson && unformedDate && hour !== "" && minute !== "") {
            const formattedDate = new Date(unformedDate);
            formattedDate.setHours(hour, minute, 0);

            console.log("Foglalás ID:", bookingId);
            console.log("Létszám:", numberOfPerson);
            console.log("Dátum:", formattedDate.toString());

            const currentDate = new Date();
            if(formattedDate < currentDate) {
                alert("Nem lehet múltbéli dátumra módosítani a foglalást!");
                return;
            }

            $.ajax({
                url: '/modify-reservation',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    reservationID: bookingId, 
                    numberOfPerson: numberOfPerson, 
                    unformedDate: formattedDate.toISOString()
                }),
                success: function(response) {
                    alert('Foglalás módosítva.');
                    $('#modifyModal').modal('hide');
                    fetchReservations();
                },
                error: function(xhr, status, error) {
                    console.error('Error occurred:', error);
                    alert('Hiba történt a foglalás módosítása során.');
                }
            });
        } else {
            alert('Kérjük, adja meg a módosított adatokat, beleértve az órát és percet!');
        }
    });


    document.addEventListener('DOMContentLoaded', fetchReservations);
</script>


<!-- Modális ablak -->
<div class="modal fade" id="modifyModal" tabindex="-1" role="dialog" aria-labelledby="modifyModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modifyModalLabel">Foglalás módosítása</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Bezárás">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="reservationDate">Foglalás dátuma</label>
                    <input type="date" id="reservationDate" class="form-control">
                </div>
                <div class="form-group">
                    <label for="reservationHour">Óra</label>
                    <input type="number" id="reservationHour" class="form-control" min="0" max="23" placeholder="Óra">
                </div>
                <div class="form-group">
                    <label for="reservationMinute">Perc</label>
                    <input type="number" id="reservationMinute" class="form-control" min="0" max="59" placeholder="Perc">
                </div>
                <div class="form-group">
                    <label for="expectedPartySize">Várható létszám</label>
                    <input type="number" id="expectedPartySize" class="form-control">
                </div>
                <div class="form-group">
                    <label for="business">Üzlet</label>
                    <input type="text" id="business" class="form-control">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="deleteReservationBtn">Foglalás törlése</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Mégse</button>
                <button type="button" id="saveChangesBtn" class="btn btn-primary">Mentés</button>
            </div>
        </div>
    </div>
</div>

</body>
</html>